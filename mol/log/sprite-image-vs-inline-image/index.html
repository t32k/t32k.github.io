<!doctype html>
<html>
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta property="fb:app_id" content="212646065416408">
        <meta property="og:type" content="article">
        <meta property="og:site_name" content="MOL">
        <title>CSS Sprite画像はDataURI画像にすべきか？ &middot; MOL</title>
        <link rel="stylesheet" href="http://localhost:1313/mol/css/skeleton.css">
        <link rel="publisher" href="//plus.google.com/+kojiishimoto">
        <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Noto+Sans:400,700">
        <link rel="alternate" href="" type="application/rss+xml" title="MOL">
    </head>
    <body role="document">
    <div class="container">
<header class="site-header">
  <nav>
    <a href="/mol/">MOL</a>
    <a href="/">About</a>
    <a href="/mol/log/">Logs</a>
    <a href="/mol/categories/">Categories</a>
    <a href="https://github.com/t32k/feedback/issues/new">Questions</a>
  </nav>
</header>

    <article class="post">
        <header class="post-header">
            <p class="t-hint">By Koji Ishimoto — <time>Wednesday, July 31, 2013</time></p>
            <h1 class="post-h1 m-0">CSS Sprite画像はDataURI画像にすべきか？</h1>
            <h4 class="t-hint"></h4>
        </header>
        <section>
            <p>最近、スプライト画像はDataURIにすべきですか？という質問が多くて、調べてみました。てか、前のもそんな話題があったような。
<div>DataURIってなんぞって方は下記を見てほしい。</div>
<div>
<ul>
    <li><a href="http://t32k.me/mol/log/data-uri-scheme/">データURIスキーム | MOL</a></li>
</ul>
</div>
<blockquote>CSSファイルがパースされなければレンダリングが始まらないのでCSSファイルの肥大化は絶対に避けなければならない。画像の1KBとCSSファイルの1KBを同じように考えてはいけない。
<a href="http://t32k.me/mol/log/the-perfect-css-i-thought/">ぼくのかんがえたさいきょうのしーえしゅえしゅ | MOL </a></blockquote>
<a href="http://molmol.tumblr.com/post/51105314376/dontrblgme-tumblr-lhl6jnlwmc1qzqmk9o1-400-jpg">憎しみと恐怖にとらわれてはいけない</a>。あ、ホントそうだっけーなーと思いつつ、どこぞの資料見たんだっけなーと探してたらあった。</p>

<p><iframe src="//www.youtube.com/embed/YV1nKLWoARQ" frameborder="0" width="560" height="315"></iframe>
<a href="https://docs.google.com/presentation/d/1IRHyU7_crIiCjl0Gvue0WY3eY_eYvFQvSfwQouW9368/present#slide=id.gc57996a9_0168">Optimizing the Critical Rendering Path for Instant Mobile Websites - Velocity SC - 2013</a></p>

<p>このセッションはすごく分かりやすいのでオススメです（該当の箇所は12分位から）。 というかIlya Grigorik++</p>

<p><img class="aligncenter  wp-image-5056" style="text-align: center;" title="1" src="/static/blog/2013/07/11.png" alt="" width="900" /></p>

<p>セッション中の資料には、ご覧のとおり、HTMLがパースされてDOMが完成したところで、画面には何も表示されない。感覚的には、スタイルのついてない『Hello world!』くらい表示されてもいいじゃんか！と思うんだけど、表示されない。
<p style="text-align: center;"><img class="aligncenter  wp-image-5055" title="2" src="/static/blog/2013/07/21.png" alt="" width="900" /></p>
次に、CSSがパースされてCSSOM（CSSのDOMみたいなもの？Style Rulesとかとも言ったりする）が構築されるが、まだ画面は空白のままだ。
<p style="text-align: center;"><img class="aligncenter  wp-image-5054" title="3" src="/static/blog/2013/07/31.png" alt="" width="900" /></p>
DOMとCSSOMがガッチャンコしてRender Treeが構築され、そこにレイアウト情報が加わって初めて描画となるんだね。この辺りの更に詳しい情報はHTML5 Rocksの以下の記事がすばらしいので読んでほしい（すぐ眠たくなるけど）。
<ul>
    <li><a href="http://www.html5rocks.com/ja/tutorials/internals/howbrowserswork/">ブラウザのしくみ: 最新ウェブブラウザの内部構造 - HTML5 Rocks</a></li>
</ul>
ここで重要なのはHTMLと（読み込んでいる）スタイルシート（CSS）が無い限り、描画はされないということだ。つまり、CSSの読み込みに手間取ればCSSレンダリングをブロックするということが考えられる。</p>

<p>レンダリングをブロックするのはJSファイルだけかと思ってたけど、スタイルシート（CSS）も気をつけなければならないということが分かる。</p>

<p>そこで冒頭にも述べたように、CSSファイルを出来る限り軽くし、読み込みを速くすることでレンダリングのブロックを回避するという考えになってくると思うが、実際どんなもんなのよ？と思ったので、テストファイル作ってみた。
<ul>
    <li><a href="https://dl.dropboxusercontent.com/u/356242/exp/httprequests/normal_sprite.html">Normal CSS Sprites</a></li>
    <li><a href="https://dl.dropboxusercontent.com/u/356242/exp/httprequests/inline_sprite.html">Inline image CSS Sprites</a></li>
</ul>
30個くらいのアイコン画像をスプライト化して読み込んでいるのと、それをさらにDataURIにしているもの比較だ。それらを<a href="http://www.webpagetest.org/">WebPagetest</a>にかけてみた。
<p style="text-align: center;"><a href="/static/blog/2013/07/filmstrip.png"><img class="aligncenter  wp-image-5040" title="filmstrip" src="/static/blog/2013/07/filmstrip.png" alt="" width="900" /></a></p>
<strong>ビジュアル比較テスト結果</strong>
<ul>
    <li><a href="http://www.webpagetest.org/video/compare.php?tests=130730_2V_G48,130730_7X_G49">WebPagetest - Visual Comparison</a></li>
</ul>
<strong>各テスト結果</strong>
<ul>
    <li><a href="http://www.webpagetest.org/result/130730_2V_G48/1/details/">WebPagetest Test Details - Dulles : Normal&hellip;/normal_sprite.html</a></li>
    <li><a href="http://www.webpagetest.org/result/130730_7X_G49/3/details/">WebPagetest Test Details - Dulles : DataURI&hellip;inline_sprite.html</a></li>
</ul>
どうでしょうか？</p>

<p>Fully Loadedがノーマルで<strong>1.187s</strong>で、DataURIが<strong>0.994s</strong>で、ビジュアル比較においても、表示完了までの時間がDataURIを使用した方が速い。まぁHTTPリクエストが2つと3つじゃ、リクエストの少ないほうが速いのは当たり前なんですけど、ここではレンダリング過程を見てほしい。</p>

<p>ノーマルは0.7秒あたりから画像なしだけどレンダリングが始まっているのに対して、その時点ではDataURIは真っ白な画面のままだ。<a href="https://sites.google.com/a/webpagetest.org/docs/using-webpagetest/quick-start-quide#TOC-Start-Render:">Start Render</a>を見ても、ノーマルが、<strong>0.697s</strong>に対して、DataURIは<strong>0.920s</strong>で、普通の画像のほうがレンダリングが速く始まっている。</p>

<p>これは先程の、Ilya Grigorik氏のプレゼン内容を理解していれば当然の現象と理解できるだろう。DataURI化した文字列を含んだCSSは<strong>59KB</strong>サイズもあるのに対して、画像パスで読み込んだCSSは<strong>3KB</strong>と軽量だ。この読み込みの差が反映された結果になっている。</p>

<p>比較のテストはシンプルな実装だが、現実問題のサイトはもっと複雑だ。どのようなレンダリング過程になるのかはサイトそれぞれだし、DataURIにして読み込み時間を最小限するというのもひとつの手段かと思う。</p>

<p><a href="https://sites.google.com/a/webpagetest.org/docs/using-webpagetest/metrics/speed-index#TOC-Measuring-Visual-Progress"><img class="aligncenter size-full wp-image-5075" title="Visual Progress" src="/static/blog/2013/07/vp.png" alt="" width="900" height="520" /></a></p>

<p>ただ、我々は機械ではないので、数値を機械的に判断するのではなく、<strong>体感速度</strong>という観点からも考えなければならない。ノーマルのテストのようなブログレッシブレンダリングは、ユーザーに即座のフィードバックを返している点で、ユーザーに安心感を与えている。</p>

<p>このような事例として、<a href="http://t32k.me/mol/log/long-life-web-performance-optimization/">検索サイトのBingはプログレッシブレンダリングをすることでユーザーの満足度を0.7％向上させた</a>(サイトリニューアル並に上昇したようです)という例もある。</p>

<p>であるので、CSSにレイアウト情報をしっかり記述したり、画像が読み込まれていない時点でのスタイルのケア（background-imageだけでなく似たような色のbackground-colorも指定しておくなど）もしておけば、後は画像が当て込まれていくだけなので体感速度は向上するといったことも考えられるだろう。</p>

<p>セッションでは、AFT(Above-the-fold time)、つまりファーストビューで見える範囲だけのCSSをHTMLにインラインで記述し、残りCSSファイルは遅延読み込みするといったテクニックが披露されているが、実際の運用ベースで使うとなると厳しいだろう。</p>

<p>そもそも的な話で、
<blockquote>
<ul>
    <li>Base64 encoding incurs transfer size overhead of 1.37 times the original data, with another 814 bytes of header data. Server gzip compression reduces this overhead to around 3% so the penalty is relatively small.</li>
    <li>The content must be decoded back into it’s original form by the browser. This operation consumes CPU &amp; battery on mobile devices.</li>
    <li>If data URIs are included in HTML or uncached CSS, the content of the data URI will be sent to the browser from the HTTP server with each request.</li>
    <li>Regardless of whether the data URI content exists in a cached CSS or HTML file, the browser must decode the image each time a page renders: the decoding cost is paid repeatedly every time a page is viewed.</li>
</ul>
</blockquote>
<a href="http://www.mobify.com/blog/data-uris-are-slow-on-mobile/">DataURIの画像は、通常の画像に比べて6倍遅いとかゆう記事</a>もありますし、ファイルサイズ自体も元より増加するし、毎回デコードしなければならなかったり、
<blockquote>Inline images judiciously
<ul>
    <li>Inlining increases parse time</li>
    <li>External images don&rsquo;t block the parser</li>
    <li>Can defer resource discovery and execution</li>
    <li>SPDY server push &gt; image inlining</li>
</ul>
</blockquote>
また、Velocity2012での<a href="https://perf-metrics-velocity2012.appspot.com/#41">Understanding and Optimizing Web Performance Metrics</a>でも、DataURIは慎重に使用しろと言われてますので、用法用量お守りの上、お使いくださいませ。</p>

<p>個人的な意見としては一回ぐらいしか出てこない画像をDataURIするのであれば、そこのビューに埋め込めばいいし、かと言って何回も出てくるような画像であれば、毎回のデコードコストが気にかかるし、ならスプライトでまとめてキャッシュさせたほうが無難でしょ！と思う。またスプライト画像も今回述べたようにレンダリングのブロックにつながる可能性があるので絶対CSSファイルには入れない、使わない。なんで、使わないかなー。使わないなー、うん。</p>

<p>参考
<ul>
    <li><a href="https://developers.google.com/speed/docs/insights/OptimizeCSSDelivery">Optimize CSS Delivery - PageSpeed Insights — Google Developers</a></li>
    <li><a href="https://developers.google.com/speed/docs/insights/PrioritizeVisibleContent">Reduce the size of the above-the-fold content - PageSpeed Insights — Google Developers</a></li>
</ul></p>

        </section>
    </article>

    <div class="post-social">
    <a href="https://twitter.com/share" class="twitter-share-button">Tweet</a>
    <div class="fb-like" data-width="150" data-layout="button_count" data-action="like" data-show-faces="true" data-send="false"></div>
    <div class="g-plusone" data-size="medium"></div>
</div>

<div class="u-cf" style="padding:2rem 0; border-radius: 1rem">
    <p class="u-pull-left"><img src="/mol/images/t32k.png" width="64" height="64" alt></p>
    <p style="margin-left: 80px">Written by <strong>Koji Ishimoto</strong>, Web Developer in Vancouver.<br>
        <a href="http://cloud.feedly.com/#subscription%2Ffeed%2Fhttp%3A%2F%2Ft32k.me%2Fmol%2Ffeed.xml" target="blank">
            <img src="http://s3.feedly.com/img/follows/feedly-follow-circle-flat-green_2x.png" width="20" height="20" alt style="vertical-align: middle"> Subscribe on feedly.</a>
    </p>
</div>

<hr>

    <div class="row li-pagination">
        <div class="six columns">
            <div class="li-pagination-previous">
                
                    Later article<br>
                    <a href="http://localhost:1313/mol/log/reverse-port-forwarding/"> Chrome CanaryとAndroid Debug BridgeとChrome for Android betaでReverse Port Forwarding</a>
                
            </div>
        </div>
        <div class="six columns">
            <div class="li-pagination-next">
                
                    Older article<br>
                    <a href="http://localhost:1313/mol/log/the-perfect-css-i-thought/"> ぼくのかんがえたさいきょうのしーえしゅえしゅ</a>
                
            </div>
        </div>
    </div>

<hr>

<section>
  <ins class="adsbygoogle"
       style="display:block"
       data-ad-client="ca-pub-1326877318485833"
       data-ad-slot="7307465775"
       data-ad-format="auto"></ins>
</section>

<hr>

<footer>
  <small roll="contentinfo">&copy; 2007 t32k.me</small>
</footer>
    <script>
        
        (function(d, s) {
            var js,
                fjs = d.getElementsByTagName(s)[0],
                load = function(url, id) {
                    if (d.getElementById(id)) {return;}
                    js = d.createElement(s); js.src = url; js.id = id;
                    fjs.parentNode.insertBefore(js, fjs);
                };
            load('//connect.facebook.net/en_US/sdk.js#xfbml=1&appId=212646065416408&version=v2.0', 'fbjssdk');
            load('//platform.twitter.com/widgets.js', 'tweetjs');
            load('https://apis.google.com/js/plusone.js', 'gplusjs');
            load('//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js', 'adsense');
        }(document, 'script'));
        
        (adsbygoogle = window.adsbygoogle || []).push({});
        
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
        ga('create', 'UA-2317436-26', 't32k.me');
        ga('send', 'pageview');
    </script>

    </div>
    <script>document.write('<script src="http://'
        + (location.host || 'localhost').split(':')[0]
		+ ':1313/livereload.js?mindelay=10"></'
        + 'script>')</script></body>
</html>